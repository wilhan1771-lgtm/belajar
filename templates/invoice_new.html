<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Buat Invoice</title>
  <style>
    body{font-family:Arial;padding:24px;background:#f3f4f6}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    input, select{padding:10px;border:1px solid #d1d5db;border-radius:10px;width:100%;box-sizing:border-box}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:10px;text-align:left}
    th{background:#f9fafb}
    .btn{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-secondary{background:#111827;color:#fff;text-decoration:none;display:inline-block}
    .muted{font-size:12px;color:#6b7280}
    hr{border:0;border-top:1px solid #e5e7eb;margin:14px 0}
  </style>
</head>
<body>

<div class="top">
  <h2>Buat Invoice (Receiving ID {{ header["id"] }})</h2>
  <a class="btn btn-secondary" href="/receiving/{{ header['id'] }}">Kembali</a>
</div>

<div class="card">
  <div><b>Tanggal:</b> {{ header["tanggal"] }} | <b>Supplier:</b> {{ header["supplier"] }}</div>

  <form method="post" style="margin-top:12px;">

    <hr>
    <h3>Term Pembayaran</h3>

<label>Jenis Pembayaran</label>
<select name="payment_type" id="payment_type">
  <option value="TRANSFER">TRANSFER</option>
  <option value="CASH">CASH</option>
</select>

<label style="margin-top:10px;">Tempo (Hari)</label>
<input type="number" step="1" min="0" name="tempo_hari" id="tempo_hari" value="{{ default_tempo }}">

<label style="margin-top:10px;">Due Date (otomatis)</label>
<input type="date" id="due_preview" value="{{ default_due }}" readonly>

<label style="margin-top:10px;">Potongan Cash per Kg (manual)</label>
<input type="number" step="1" min="0" name="cash_deduct_per_kg" id="cash_deduct_per_kg" value="0">

<h3 style="margin-top:14px;">Reject (Opsional)</h3>
<label>Reject (Kg)</label>
<input type="number" step="0.01" min="0" name="reject_kg" value="0">

<label style="margin-top:10px;">Harga Reject per Kg (manual)</label>
<input type="number" step="1" min="0" name="reject_price" value="0">

<script>
(function(){
  const pay = document.getElementById("payment_type");
  const tempo = document.getElementById("tempo_hari");
  const due = document.getElementById("due_preview");

  const invoiceDateStr = "{{ header['tanggal'] }}"; // YYYY-MM-DD
  const invoiceDate = new Date(invoiceDateStr + "T00:00:00");

  function fmt(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function recalcDue(){
    const days = parseInt(tempo.value || "0", 10) || 0;
    const d = new Date(invoiceDate);
    d.setDate(d.getDate() + days);
    due.value = fmt(d);
  }

  function applyDefaults(){
    if(pay.value === "CASH"){
      tempo.value = 1; // cash default besok
    } else {
      tempo.value = 7; // transfer default 7 hari
      document.getElementById("cash_deduct_per_kg").value = 0;
    }
    recalcDue();
  }

  pay.addEventListener("change", applyDefaults);
  tempo.addEventListener("input", recalcDue);

  applyDefaults();
})();
</script>


    <hr>
    <h3>Reject (Opsional)</h3>

    <label>Reject (Kg)</label>
    <input type="number" step="0.01" min="0" name="reject_kg" value="0">

    <label style="margin-top:10px;">Harga Reject per Kg (isi manual, 0 jika diambil balik supplier)</label>
    <input type="number" step="1" min="0" name="reject_price" value="0">

    <hr>
    <h3>Input Harga Patokan (Hari Ini)</h3>

    <div class="grid">
      {% for sz in required_sizes %}
      <div>
        <div>Harga size {{ sz }}</div>
        <input name="p{{ sz }}" type="number" placeholder="isi harga size {{ sz }}">
      </div>
      {% endfor %}
    </div>

    <div style="margin-top:10px;max-width:220px;">
      <label>PPH (%) <span class="muted">(opsional)</span></label>
      <input type="number" name="pph" step="0.01" min="0" placeholder="Contoh: 0.4 = 0.4%">
    </div>

    <hr>
    <h3>Data Partai (dari Receiving)</h3>
    <table>
      <thead>
        <tr>
          <th>Partai</th>
          <th>Round Size</th>
          <th>Netto (kg)</th>
        </tr>
      </thead>
      <tbody>
        {% for p in partai %}
        <tr>
          <td>{{ p["partai_no"] }}</td>
          <td>{{ p["round_size"] if p["round_size"] is not none else "-" }}</td>
          <td>{{ "%.2f"|format(p["netto"] or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button class="btn btn-primary" type="submit" style="margin-top:12px;">Generate Invoice</button>
  </form>
</div>

</body>
</html>
