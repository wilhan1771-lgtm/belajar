<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Buat Invoice</title>
  <style>
    body{font-family:Arial;padding:24px;background:#f3f4f6}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .section-title{margin:0 0 8px 0}
    .field label{display:block;font-size:13px;color:#374151;margin-bottom:6px}
    .readonly{background:#f9fafb}
    @media (max-width: 900px){
      .grid-3{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
    input, select{padding:10px;border:1px solid #d1d5db;border-radius:10px;width:100%;box-sizing:border-box}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:10px;text-align:left}
    th{background:#f9fafb}
    .btn{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-secondary{background:#111827;color:#fff;text-decoration:none;display:inline-block}
    .muted{font-size:12px;color:#6b7280}
    hr{border:0;border-top:1px solid #e5e7eb;margin:14px 0}
  </style>
</head>
<body>

<div class="top">
  <h2>Buat Invoice (Receiving ID {{ header["id"] }})</h2>
  <a class="btn btn-secondary" href="/receiving/{{ header['id'] }}">Kembali</a>
</div>

<div class="card">
  <div><b>Tanggal:</b> {{ header["tanggal"] }} | <b>Supplier:</b> {{ header["supplier"] }}</div>

  <form method="post" style="margin-top:12px;">

    <hr>
    <h3 class="section-title">Term Pembayaran</h3>

    <div class="grid-3">
      <div class="field">
        <label for="payment_type">Jenis Pembayaran</label>
        <select name="payment_type" id="payment_type">
          <option value="TRANSFER">TRANSFER</option>
          <option value="CASH">CASH</option>
        </select>
      </div>

      <div class="field">
        <label for="tempo_hari">Tempo (Hari)</label>
        <input type="number" step="1" min="0" name="tempo_hari" id="tempo_hari" value="{{ default_tempo }}" required>
      </div>

      <div class="field">
        <label for="due_preview">Due Date (otomatis)</label>
        <input type="date" id="due_preview" value="{{ default_due }}" readonly class="readonly">
        <!-- biar pasti ikut terkirim -->
        <input type="hidden" name="due_date" id="due_hidden" value="{{ default_due }}">
      </div>
    </div>

    <hr>
    <h3 class="section-title">Adjustment (Opsional)</h3>

    <div class="grid-3">
      <div class="field">
        <label for="cash_deduct_per_kg">Potongan Cash per Kg</label>
        <input type="number" step="1" min="0" name="cash_deduct_per_kg" id="cash_deduct_per_kg" value="0">
      </div>

      <div class="field">
        <label for="reject_kg">Reject (Kg)</label>
        <input type="number" step="0.01" min="0" name="reject_kg" id="reject_kg" value="0">
      </div>

      <div class="field">
        <label for="reject_price">Harga Reject per Kg</label>
        <input type="number" step="1" min="0" name="reject_price" id="reject_price" value="0">
      </div>
    </div>

    <div class="grid-3" style="margin-top:10px;">
      <div class="field">
        <label for="reject_mode">Mode Reject</label>
        <select name="reject_mode" id="reject_mode">
          <option value="RETURN">Diambil balik (tidak dibayar, potong berat)</option>
          <option value="PAY">Dibayar (masuk invoice)</option>
        </select>
      </div>
      <div class="field"></div>
      <div class="field"></div>
    </div>

    <script>
    (function(){
      const pay = document.getElementById("payment_type");
      const tempo = document.getElementById("tempo_hari");
      const due = document.getElementById("due_preview");
      const dueHidden = document.getElementById("due_hidden");
      const cashDeduct = document.getElementById("cash_deduct_per_kg");

      const invoiceDateStr = "{{ header['tanggal'] }}"; // YYYY-MM-DD
      const invoiceDate = new Date(invoiceDateStr + "T00:00:00");

      function fmt(d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }

      function recalcDue(){
        const days = parseInt(tempo.value || "0", 10) || 0;
        const d = new Date(invoiceDate);
        d.setDate(d.getDate() + days);
        const v = fmt(d);
        due.value = v;
        dueHidden.value = v;
      }

      // Auto-set tempo hanya saat user ganti payment_type
      function applyDefaultsByPayment(){
        if(pay.value === "CASH"){
          tempo.value = 1;
          cashDeduct.value = cashDeduct.value || 0;
        } else {
          tempo.value = 7;
          cashDeduct.value = cashDeduct.value || 0;
        }
        recalcDue();
      }

      pay.addEventListener("change", applyDefaultsByPayment);
      tempo.addEventListener("input", recalcDue);

      // awal: jangan override tempo dari backend, cukup hitung due dari value yg ada
      recalcDue();
    })();
    </script>

    <hr>
    <h3>Input Harga Patokan (Hari Ini)</h3>

    {% if required_sizes and required_sizes|length > 0 %}
      <div class="grid">
        {% for sz in required_sizes %}
        <div class="field">
          <label>Harga size {{ sz }}</label>
          <input name="p{{ sz }}" type="number" step="1" min="0" placeholder="isi harga size {{ sz }}" required>
        </div>
        {% endfor %}
      </div>
      <div class="muted" style="margin-top:8px;">
        Harga akan dihitung otomatis berdasarkan round size partai (interpolate).
      </div>
    {% else %}
   <div class="muted" style="color:#b45309;font-weight:600;">
      Round Size belum ada di Receiving.
     Invoice tetap bisa dibuat, namun harga akan diisi manual di halaman Edit Invoice.
    </div>
    {% endif %}


    <div style="margin-top:10px;max-width:220px;">
      <label>PPH (%) <span class="muted">(opsional)</span></label>
      <input type="number" name="pph" step="0.01" min="0" placeholder="Contoh: 0.4 = 0.4%">
    </div>

    <hr>
    <h3>Data Partai (dari Receiving)</h3>
    <table>
      <thead>
        <tr>
          <th>Partai</th>
          <th>Round Size</th>
          <th>Netto (kg)</th>
        </tr>
      </thead>
      <tbody>
        {% for p in partai %}
        <tr>
          <td>{{ p["partai_no"] }}</td>
          <td>{{ p["round_size"] if p["round_size"] is not none else "-" }}</td>
          <td>{{ "%.2f"|format(p["netto"] or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button class="btn btn-primary" type="submit" style="margin-top:12px;">Generate Invoice</button>
  </form>
</div>

</body>
</html>
