<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Produksi / Yield</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; background:#f3f4f6; color:#111827; }
    h2 { margin:0 0 12px 0; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap; }
    .btn { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; text-decoration:none; display:inline-block; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }
    .muted { color:#6b7280; font-size:13px; margin-top:6px; }

    .card { background:white; border:1px solid #e5e7eb; border-radius:14px; padding:16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-top:14px; }

    .grid4 { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 13px; }
    input { padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; background:white; }
    input[readonly] { background:#f9fafb; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; vertical-align: top; }
    th { background:#f9fafb; }

    .pill { display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }

    @media (max-width: 900px){
      .grid4 { grid-template-columns: 1fr 1fr; }
      .grid3 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      body { padding: 16px; }
      .grid4, .grid3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="top">
  <div>
    <h2>Produksi / Yield <span class="pill">1 Receiving = 1 Produksi</span></h2>
    <div class="muted">Kupas (tahapan) otomatis dari total Kupas(kg) tabel packing.</div>
  </div>
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn btn-secondary" href="/receiving/{{ receiving.id }}">← Kembali ke Receiving</a>
    <button class="btn btn-primary" id="btnSave" type="button">Save</button>
  </div>
</div>

<!-- INFO RECEIVING -->
<div class="card">
  <div class="grid4">
    <div class="field">
      <label>Tanggal</label>
      <input type="text" value="{{ receiving.tanggal }}" readonly>
    </div>
    <div class="field">
      <label>Supplier</label>
      <input type="text" value="{{ receiving.supplier }}" readonly>
    </div>
    <div class="field">
      <label>Jenis</label>
      <input type="text" value="{{ receiving.jenis or '-' }}" readonly>
    </div>
    <div class="field">
      <label>Bahan Masuk (kg)</label>
      <input type="text" id="bahanMasuk" value="{{ '%.2f'|format(receiving.total_netto or 0) }}" readonly>
    </div>
  </div>
</div>

<!-- TAHAPAN YIELD -->
<div class="card">
  <h3 style="margin:0 0 8px 0;">Tahapan Yield</h3>
  <div class="muted">Yield % tahap = (berat tahap / bahan masuk) × 100.</div>

  <div class="grid3" style="margin-top:12px;">
    <div class="field">
      <label>HL (kg)</label>
      <input type="number" step="0.01" id="hlKg" placeholder="contoh: 2700">
      <div class="muted">Yield: <b id="hlPct">0.00%</b></div>
    </div>

    <div class="field">
      <label>Kupas (kg) (otomatis dari tabel packing)</label>
      <input type="number" step="0.01" id="kupasKg" readonly>
      <div class="muted">Yield: <b id="kupasPct">0.00%</b></div>
    </div>

    <div class="field">
      <label>Soaking (kg)</label>
      <input type="number" step="0.01" id="soakKg" readonly>
      <div class="muted">Yield: <b id="soakPct">0.00%</b></div>
    </div>
  </div>

  <div style="margin-top:12px; padding:10px 12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px;">
    <b>Final Yield (Soaking / Bahan Masuk):</b> <span id="finalPct">0.00%</span>
  </div>
</div>

<!-- PACKING PER SIZE -->
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
    <div>
      <h3 style="margin:0;">Packing / Sortir Size</h3>
      <div class="muted">
        TotalKg = MC × Berat/Dus.
        Kolom "Yield %" = kenaikan dari Kupas → TotalKg:
        ((TotalKg - KupasKg) / KupasKg) × 100.
      </div>
    </div>
    <button class="btn btn-secondary" id="btnAddRow" type="button">+ Baris</button>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:140px;">Size</th>
        <th style="width:140px;">Kupas (kg)</th>
        <th style="width:140px;">MC (isi/dus)</th>
        <th style="width:140px;">Berat/Dus (kg)</th>
        <th style="width:140px;">Total Kg</th>
        <th style="width:120px;">Yield %</th>
      </tr>
    </thead>
    <tbody id="packingBody"></tbody>
  </table>

  <div style="margin-top:12px; padding:10px 12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px;">
    <b>Total Packing (kg):</b> <span id="packTotalKg">0.00</span>
    <span class="muted"> | Total packing biasanya mendekati Soaking.</span>
  </div>
</div>

<script>
  // =========================
  // Helpers
  // =========================
  function num(v) {
    const x = parseFloat((v ?? "").toString().replace(",", "."));
    return isNaN(x) ? 0 : x;
  }
  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // =========================
  // DOM refs
  // =========================
  const bahanMasuk = num(document.getElementById("bahanMasuk").value);

  const hlKg = document.getElementById("hlKg");
  const kupasKg = document.getElementById("kupasKg");
  const soakKg = document.getElementById("soakKg");

  const hlPct = document.getElementById("hlPct");
  const kupasPct = document.getElementById("kupasPct");
  const soakPct = document.getElementById("soakPct");
  const finalPct = document.getElementById("finalPct");

  const packingBody = document.getElementById("packingBody");
  const packTotalKg = document.getElementById("packTotalKg");

  // =========================
  // Yield Tahapan
  // =========================
  function pctTahap(x) {
    if (!bahanMasuk || bahanMasuk <= 0) return 0;
    return (num(x) / bahanMasuk) * 100.0;
  }

  function updateYieldUI() {
    const hl = num(hlKg.value);
    const kp = num(kupasKg.value);
    const sk = num(soakKg.value);

    hlPct.textContent = pctTahap(hl).toFixed(2) + "%";
    kupasPct.textContent = pctTahap(kp).toFixed(2) + "%";
    soakPct.textContent = pctTahap(sk).toFixed(2) + "%";
    finalPct.textContent = pctTahap(sk).toFixed(2) + "%";
  }

  hlKg.addEventListener("input", updateYieldUI);
  soakKg.addEventListener("input", updateYieldUI);

  // =========================
  // Packing calculations
  // =========================
  function recalcRow(tr) {
    const kupas = num(tr.querySelector(".p-kupas").value);
    const mc = num(tr.querySelector(".p-mc").value);
    const beratDus = num(tr.querySelector(".p-beratdus").value);

    const totalKg = mc * beratDus;

    // Yield% = kenaikan dari kupas → total
    // ((total - kupas) / kupas) * 100
    const yieldPct = kupas > 0 ? ((totalKg - kupas) / kupas) * 100.0 : 0;

    tr.querySelector(".p-total").value = totalKg > 0 ? totalKg.toFixed(2) : "";
    tr.querySelector(".p-yield").value = (kupas > 0 && totalKg > 0) ? yieldPct.toFixed(2) : "";
  }

  function updateKupasFromPacking() {
    let totalKupas = 0;
    packingBody.querySelectorAll("tr").forEach(tr => {
      totalKupas += num(tr.querySelector(".p-kupas")?.value);
    });
    kupasKg.value = totalKupas.toFixed(2);
    updateYieldUI();
  }
function updatePackTotal() {
  let totalPacking = 0;
  packingBody.querySelectorAll("tr").forEach(tr => {
    totalPacking += num(tr.querySelector(".p-total")?.value);
  });

  packTotalKg.textContent = totalPacking.toFixed(2);

  // ✅ AUTO: Soaking mengikuti total packing
  soakKg.value = totalPacking.toFixed(2);

  // Kupas tahapan juga auto
  updateKupasFromPacking();

  // refresh yield
  updateYieldUI();
}

  function makeRow(data = {}) {
    const tr = document.createElement("tr");
  tr.innerHTML = `
  <td><input class="p-size" type="text" placeholder="contoh: 31/40"
      value="${escapeHtml(data.size || "")}"></td>

  <td><input class="p-kupas" type="number" step="0.01" placeholder="contoh: 400"
      value="${data.kupas_kg ?? ""}"></td>

  <td><input class="p-mc" type="number" step="0.01" placeholder="contoh: 57.5"
      value="${data.mc ?? ""}"></td>

  <td><input class="p-beratdus" type="number" step="0.01" placeholder="contoh: 8"
      value="${data.berat_per_dus ?? ""}"></td>

  <td><input class="p-total" type="text" readonly value="${(data.total_kg ?? "")}"></td>
  <td><input class="p-yield" type="text" readonly value=""></td>
`;


    tr.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        recalcRow(tr);
        updatePackTotal();
      });
    });

    // init
    recalcRow(tr);
    return tr;
  }

  document.getElementById("btnAddRow").addEventListener("click", () => {
    packingBody.appendChild(makeRow({}));
    updatePackTotal();
  });

  // =========================
  // Preload from server
  // =========================
  (function preloadSteps() {
    const steps = {{ steps|tojson }};
    for (const s of steps) {
      const name = (s.step_name || "").toUpperCase();
      const kg = (s.berat_kg ?? 0);
      if (name === "HL") hlKg.value = kg;
      if (name === "SOAKING") soakKg.value = kg;
      // KUPAS tidak diisi dari step, karena otomatis dari packing
    }
    updateYieldUI();
  })();

  (function preloadPacking() {
    const rows = {{ packing|tojson }};
    if (!rows || rows.length === 0) {
      packingBody.appendChild(makeRow({}));
    } else {
      for (const r of rows) {
        packingBody.appendChild(makeRow(r));
      }
    }
    updatePackTotal();
  })();

  // =========================
  // Save
  // =========================
  document.getElementById("btnSave").addEventListener("click", async () => {
    const payload = {
      hl: num(hlKg.value),
      kupas: num(kupasKg.value),     // sudah otomatis dari packing
      soaking: num(soakKg.value),
      packing: []
    };

    packingBody.querySelectorAll("tr").forEach(tr => {
      const size = (tr.querySelector(".p-size").value || "").trim();
      const kupas = num(tr.querySelector(".p-kupas").value);
      const mc = tr.querySelector(".p-mc").value;
      const beratDus = tr.querySelector(".p-beratdus").value;

      const kosong = !size && kupas === 0 && !mc && !beratDus;
      if (kosong) return;

      payload.packing.push({
          size: size,
          kupas_kg: kupas,
          mc: num(mc),
          berat_per_dus: num(beratDus)
        });

          });

    try {
      const res = await fetch("/production/save/{{ receiving.id }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      const out = await res.json();
      if (!res.ok || !out.ok) {
        alert(out.msg || "Gagal simpan");
        return;
      }

      alert("Produksi berhasil disimpan!");
    } catch (e) {
      alert("Error koneksi: " + e);
    }
  });
</script>

</body>
</html>
