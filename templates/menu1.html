<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Receiving</title>

<style>
body{font-family:Arial,sans-serif;padding:24px;background:#f3f4f6}
h2{margin-bottom:12px}
.field{display:flex;flex-direction:column;gap:6px}
input,select{padding:10px;border:1px solid #d1d5db;border-radius:10px}
input[readonly]{background:#f9fafb}
.btn{padding:10px 14px;border:0;border-radius:10px;font-weight:600;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#111827;color:#fff}
.partai{background:#fff;border-radius:14px;padding:16px;margin-top:14px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.section{margin-top:14px;padding-top:12px;border-top:1px dashed #e5e7eb}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e5e7eb;padding:8px}
th{background:#f9fafb}
.muted{font-size:13px;color:#6b7280}
</style>
</head>

<body>
<h2>Receiving</h2>

<div class="grid4">
  <div class="field">
    <label>Tanggal</label>
    <input id="tanggal" type="date">
  </div>
  <div class="field">
    <label>Supplier</label>
    <select id="supplier"></select>
  </div>
  <div class="field">
    <label>Jenis Udang</label>
    <select id="jenis"></select>
  </div>
  <div class="field">
    <label>&nbsp;</label>
    <button class="btn btn-primary" id="btnSave">Save</button>
  </div>
</div>

<div id="partaiContainer"></div>

<script>
const $ = id => document.getElementById(id);
let partaiKe = 0;

async function loadMasters(){
  $("supplier").innerHTML = `<option value="">-- Pilih --</option>`;
  $("jenis").innerHTML = `
    <option value="">-- Pilih --</option>
    <option value="vannamei">Vannamei</option>
    <option value="dogol">Dogol</option>
    <option value="kupasan">Kupasan</option>
  `;
}

function buatPartai(){
  partaiKe++;
  const d = document.createElement("div");
  d.className="partai";
  d.dataset.no=partaiKe;

  d.innerHTML=`
  <h3>Partai #${partaiKe}</h3>

  <div class="section sampling">
    <div class="grid4">
      <div class="field">
        <label>PCS</label>
        <input id="pcs-${partaiKe}" type="number">
      </div>
      <div class="field">
        <label>Kg Sample</label>
        <input id="kg-${partaiKe}" type="number" step="0.01">
      </div>
      <div class="field">
        <label>Size</label>
        <input id="size-${partaiKe}" readonly>
      </div>
      <div class="field">
        <label>Round Size</label>
        <input id="round-${partaiKe}" readonly>
      </div>
    </div>
  </div>

  <div class="section kupasan" style="display:none">
    <div class="field">
      <label>Kategori Kupasan</label>
      <select id="kupasan-${partaiKe}">
        <option value="">-- Pilih --</option>
        <option value="besar">Besar</option>
        <option value="kecil">Kecil</option>
      </select>
    </div>
  </div>

  <div class="section">
    <div class="grid4">
      <div class="field">
        <label>Keranjang</label>
        <input id="keranjang-${partaiKe}" readonly>
      </div>
      <div class="field">
        <label>Tara / Keranjang</label>
        <input id="tara-${partaiKe}" type="number" step="0.01">
      </div>
      <div class="field">
        <label>Bruto</label>
        <input id="bruto-${partaiKe}" readonly>
      </div>
      <div class="field">
        <label>Netto</label>
        <input id="netto-${partaiKe}" readonly>
      </div>
    </div>
  </div>

  <table>
    <thead><tr><th>No</th><th>Berat</th></tr></thead>
    <tbody id="tb-${partaiKe}"></tbody>
  </table>

  <button class="btn btn-secondary" onclick="tambahBaris(${partaiKe})">+ Baris</button>
  `;

  $("partaiContainer").appendChild(d);
  tambahBaris(partaiKe);

  $(`pcs-${partaiKe}`).oninput = () => hitungSize(partaiKe);
  $(`kg-${partaiKe}`).oninput  = () => hitungSize(partaiKe);
}

function tambahBaris(p){
  const tb = $(`tb-${p}`);
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${tb.children.length+1}</td>
                  <td><input type="number" step="0.01"></td>`;
  tb.appendChild(tr);
  tr.querySelector("input").oninput = () => hitungBerat(p);
}

function hitungSize(p){
  const pcs = +$(`pcs-${p}`).value;
  const kg  = +$(`kg-${p}`).value;
  if(pcs>0 && kg>0){
    const size = pcs/kg;
    $(`size-${p}`).value = size.toFixed(1);
    $(`round-${p}`).value = Math.round(size);
  }
}

function hitungBerat(p){
  let bruto=0, k=0;
  document.querySelectorAll(`#tb-${p} input`).forEach(i=>{
    if(i.value){bruto+=+i.value;k++}
  });
  $(`keranjang-${p}`).value = k||"";
  $(`bruto-${p}`).value = bruto?bruto.toFixed(2):"";
  const tara = +$(`tara-${p}`).value||0;
  $(`netto-${p}`).value = bruto && tara ? (bruto - k*tara).toFixed(2):"";
}

$("jenis").onchange = ()=>{
  const isKupasan = $("jenis").value==="kupasan";
  document.querySelectorAll(".partai").forEach(p=>{
    p.querySelector(".sampling").style.display = isKupasan?"none":"";
    p.querySelector(".kupasan").style.display = isKupasan?"":"none";
  });
};

$("btnSave").onclick = ()=>{
  const data=[];
  document.querySelectorAll(".partai").forEach(p=>{
    const no=p.dataset.no;
    data.push({
      partai:no,
      pcs:$(`pcs-${no}`)?.value||null,
      kg_sample:$(`kg-${no}`)?.value||null,
      round_size:$(`round-${no}`)?.value||null,
      kupasan_grade:$(`kupasan-${no}`)?.value||null,
      netto:$(`netto-${no}`)?.value||null
    });
  });
  console.log(data);
  alert("Payload aman, cek console");
};

loadMasters();
buatPartai();
</script>
</body>
</html>
