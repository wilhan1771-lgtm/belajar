<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Receiving</title>

<style>
body{font-family:Arial,sans-serif;padding:24px;background:#f3f4f6}
h2{margin-bottom:12px}
.field{display:flex;flex-direction:column;gap:6px}
input,select{padding:10px;border:1px solid #d1d5db;border-radius:10px}
input[readonly]{background:#f9fafb}
.btn{padding:10px 14px;border:0;border-radius:10px;font-weight:600;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#111827;color:#fff}
.partai{background:#fff;border-radius:14px;padding:16px;margin-top:14px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.section{margin-top:14px;padding-top:12px;border-top:1px dashed #e5e7eb}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e5e7eb;padding:8px}
th{background:#f9fafb}
.muted{font-size:13px;color:#6b7280}
</style>
</head>

<body>
<h2>Receiving</h2>

<div class="grid4">
  <div class="field">
    <label>Tanggal</label>
    <input id="tanggal" type="date">
  </div>
  <div class="field">
    <label>Supplier</label>
    <select id="supplier"></select>
  </div>
  <div class="field">
    <label>Jenis Udang</label>
    <select id="jenis"></select>
  </div>
  <div class="field">
    <label>&nbsp;</label>
    <button type="button" class="btn btn-primary" id="btnSave">Save</button>
  </div>
</div>

<div id="partaiContainer"></div>

<script>
const $ = id => document.getElementById(id);
let partaiKe = 0;

async function loadSuppliers() {
  const sel = $("supplier");
  sel.innerHTML = `<option value="">-- Pilih Supplier --</option>`;

  const res = await fetch("/master/suppliers");
  const data = await res.json();

  data.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.nama;
    opt.textContent = r.nama;
    sel.appendChild(opt);
  });
}
document.getElementById("jenis").addEventListener("change", e => {
  const jenis = e.target.value;

  document.querySelectorAll(".partai").forEach(p => {
    const sampling = p.querySelector(".section.sampling");
    const kupasan  = p.querySelector(".section.kupasan");

    if (jenis === "kupasan") {
      if (sampling) sampling.style.display = "none";
      if (kupasan)  kupasan.style.display  = "block";
    } else {
      if (sampling) sampling.style.display = "block";
      if (kupasan)  kupasan.style.display  = "none";
    }
  });
});

function loadJenis() {
  $("jenis").innerHTML = `
    <option value="">-- Pilih --</option>
    <option value="vannamei">Vannamei</option>
    <option value="dogol">Dogol</option>
    <option value="kupasan">Kupasan</option>
  `;
}

async function saveReceiving() {
  if (!$("tanggal").value) {
    alert("Tanggal wajib diisi");
    return;
  }

  if (!$("supplier").value) {
    alert("Supplier wajib dipilih");
    return;
  }

  if (!$("jenis").value) {
    alert("Jenis udang wajib dipilih");
    return;
  }

  const payload = {
    tanggal: $("tanggal").value,
    supplier: $("supplier").value,
    jenis: $("jenis").value,
    fiber: $("fiber")?.checked ? 1 : 0,
    partai: []
  };
payload.partai = [];

try {
  document.querySelectorAll(".partai").forEach(div => {
    const p = div.dataset.no;

    const tara = Number($(`tara-${p}`)?.value || 0);
    if (tara <= 0) {
      throw `Tara keranjang wajib diisi di Partai #${p}`;
    }

    const timbangan = [];
    div.querySelectorAll(".inp-berat").forEach(inp => {
      const v = Number(inp.value);
      if (v > 0) timbangan.push(v);
    });

    payload.partai.push({
      partai_no: Number(p),
      pcs: Number($(`pcs-${p}`)?.value || 0),
      kg_sample: Number($(`kg-${p}`)?.value || 0),
      tara_per_keranjang: tara,
      kategori_kupasan: $(`kupasan-${p}`)?.value || null,
      note: $(`note-${p}`)?.value || "",
      timbangan: timbangan
    });
  });
} catch (msg) {
  alert(msg);
  return;
}

  console.log("PAYLOAD:", payload); // ðŸ”¥ WAJIB ADA

  const res = await fetch("/receiving/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.ok) {
    alert(json.msg || "Gagal simpan");
    return;
  }

  alert("Data berhasil disimpan");
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnSave");
  if (btn) btn.onclick = saveReceiving;
});

/* ================= PARTAI ================= */

function buatPartai(){
  partaiKe++;

  const d = document.createElement("div");
  d.className = "partai";
  d.dataset.no = partaiKe;

  d.innerHTML = `
    <h3>Partai #${partaiKe}</h3>

    <!-- ===== SAMPLING (VANNAMEI / DOGOL) ===== -->
    <div class="section sampling">
      <div class="grid4">
        <div class="field">
          <label>PCS</label>
          <input id="pcs-${partaiKe}" type="number">
        </div>

        <div class="field">
          <label>Kg Sample</label>
          <input id="kg-${partaiKe}" type="number" step="0.01">
        </div>

        <div class="field">
          <label>Size</label>
          <input id="size-${partaiKe}" readonly>
        </div>

        <div class="field">
          <label>Round Size</label>
          <input id="round-${partaiKe}" readonly>
        </div>
      </div>
    </div>

    <!-- ===== KUPASAN ===== -->
    <div class="section kupasan" style="display:none">
      <div class="field">
        <label>Kategori Kupasan</label>
        <select id="kupasan-${partaiKe}">
          <option value="">-- Pilih --</option>
          <option value="besar">Besar</option>
          <option value="kecil">Kecil</option>
        </select>
      </div>
    </div>

    <!-- ===== TIMBANGAN SUMMARY ===== -->
    <div class="section">
      <div class="grid4">
        <div class="field">
          <label>Keranjang</label>
          <input id="keranjang-${partaiKe}" readonly>
        </div>

        <div class="field">
          <label>Tara / Keranjang</label>
          <input id="tara-${partaiKe}" type="number" step="0.01" value="0">
        </div>

        <div class="field">
          <label>Total Tara</label>
          <input id="total-tara-${partaiKe}" readonly>
        </div>

        <div class="field">
          <label>Bruto</label>
          <input id="bruto-${partaiKe}" readonly>
        </div>

        <div class="field">
          <label>Netto</label>
          <input id="netto-${partaiKe}" readonly>
        </div>

        <div class="field">
          <label>Catatan</label>
          <input id="note-${partaiKe}" placeholder="Kondisi udang">
        </div>
      </div>
    </div>

    <!-- ===== TABEL TIMBANGAN ===== -->
    <table>
      <thead>
        <tr><th>No</th><th>Berat</th></tr>
      </thead>
      <tbody id="tb-${partaiKe}"></tbody>
    </table>

    <button type="button" class="btn btn-secondary" onclick="tambahBaris(${partaiKe})">
      + Baris
    </button>

    <button type="button" class="btn btn-secondary btn-new-partai">
      + Partai Baru
    </button>
  `;

// ðŸ”¥ TAMBAHKAN DI SINI
const jenisAktif = $("jenis")?.value;
const sampling = d.querySelector(".sampling");
const kupasan  = d.querySelector(".kupasan");

if (jenisAktif === "kupasan") {
  sampling.style.display = "none";
  kupasan.style.display  = "block";
} else {
  sampling.style.display = "block";
  kupasan.style.display  = "none";
}

  $("partaiContainer").appendChild(d);

  d.querySelector(".btn-new-partai").onclick = buatPartai;

  tambahBaris(partaiKe);

  // EVENT
  $(`pcs-${partaiKe}`).oninput  = () => hitungSize(partaiKe);
  $(`kg-${partaiKe}`).oninput   = () => hitungSize(partaiKe);
  $(`tara-${partaiKe}`).oninput = () => hitungBerat(partaiKe);
}

function tambahBaris(p){
  const tb = document.getElementById(`tb-${p}`);
  const no = tb.children.length + 1;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${no}</td>
    <td>
      <input type="number" step="0.01" class="inp-berat">
    </td>
  `;

  tb.appendChild(tr);

  const inp = tr.querySelector("input");

  inp.oninput = () => hitungBerat(p);

  inp.onkeydown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      tambahBaris(p);   // âž• BARIS BARU
    }
  };

  inp.focus();
}

/* ================= HITUNG ================= */
function hitungBerat(p){
  const inputs = document.querySelectorAll(`#tb-${p} input`);

  let bruto = 0;
  let keranjang = 0;

  inputs.forEach(i => {
    const v = parseFloat(i.value);
    if (!isNaN(v) && v > 0) {
      bruto += v;
      keranjang += 1;
    }
  });

  const taraPerKeranjang = parseFloat($(`tara-${p}`).value);
  const taraValid = !isNaN(taraPerKeranjang) && taraPerKeranjang > 0;

  const totalTara = taraValid ? keranjang * taraPerKeranjang : 0;
  const netto = bruto - totalTara;

  $(`keranjang-${p}`).value = keranjang || "";
  $(`bruto-${p}`).value = bruto > 0 ? bruto.toFixed(2) : "";
  $(`total-tara-${p}`).value = totalTara > 0 ? totalTara.toFixed(2) : "";
  $(`netto-${p}`).value = netto > 0 ? netto.toFixed(2) : "";
}

function hitungSize(p) {
  const pcs = parseFloat($(`pcs-${p}`).value);
  const kg  = parseFloat($(`kg-${p}`).value);

  if (pcs > 0 && kg > 0) {
    const size = pcs / kg;

    // pembulatan normal
    const round = Math.round(size);

    $(`size-${p}`).value  = size.toFixed(1);
    $(`round-${p}`).value = round;
  } else {
    $(`size-${p}`).value  = "";
    $(`round-${p}`).value = "";
  }
}
document.addEventListener("DOMContentLoaded", () => {
  loadSuppliers();
  loadJenis();
  buatPartai();
});

/* ================= INIT ================= */
window.onload = () => {
  loadMasters();
  buatPartai();
};
</script>

</body>
</html>
