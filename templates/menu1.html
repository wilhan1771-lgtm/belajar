<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receiving</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; background:#f3f4f6; color:#111827; }
    h2 { margin: 0 0 14px 0; }

    .header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 12px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 15px; color:#111827; }
    input, select { padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; background:#fff; box-sizing:border-box; }
    input[readonly] { background:#f9fafb; }

    .btn { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; height:40px; display:inline-flex; align-items:center; justify-content:center; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }

    .muted { color: #6b7280; font-size: 13px; margin-top: 6px; }

    .partai {
      background:#fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin-top: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .toprow { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 8px; }
    .row-actions { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-top:10px; }
    .pill { display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
    th { background:#f9fafb; }
    .header .btn { width: 100%; }


    .section { margin-top:14px; padding-top:12px; border-top:1px dashed #e5e7eb; }
    .grid4 { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; align-items:end; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; align-items:end; }

    @media (max-width: 900px){
      .header { grid-template-columns: 1fr 1fr; }
      .grid4 { grid-template-columns: 1fr 1fr; }
      .grid3 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      body { padding: 16px; }
      .header { grid-template-columns: 1fr; }
      .grid4 { grid-template-columns: 1fr; }
      .grid3 { grid-template-columns: 1fr; }
      .toprow { flex-direction: column; align-items: flex-start; }
      .row-actions { width: 100%; }
      .row-actions .btn { width: 100%; }
    }
    .test-flag{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:8px;
  font-size:13px;
  color:#374151;
}
.test-flag input{
  width:auto;
  height:auto;
}

  </style>
</head>
<body>

<h2>Receiving</h2>

<div class="header">
  <div class="field">
    <label>Tanggal</label>
    <input id="tanggal" type="date" value="{{ today }}">
    <label class="test-flag">
      <input type="checkbox" id="is_test">
      Mode Test
    </label>
  </div>

  <div class="field">
    <label>Supplier</label>
    <select id="supplier">
      <option value="">-- Pilih Supplier --</option>
    </select>

    <input id="supplier_new" type="text" placeholder="Tambah supplier baru (opsional)">
    <button type="button" class="btn btn-secondary" id="btnAddSupplier">+ Supplier</button>
  </div>

  <div class="field">
    <label>Jenis Udang</label>
    <select id="jenis">
      <option value="">-- Pilih Jenis Udang --</option>
    </select>
  </div>

  <div class="field">
    <label>Fiber</label>
    <input id="fiber" type="number" step="0.01" placeholder="Contoh: 24">
  </div>

  <div class="field">
    <label>&nbsp;</label>
    <button class="btn btn-primary" id="btnSave" type="button">Save</button>
  </div>
</div>


<div class="muted">
  Cara input: ketik timbangannya lalu tekan <b>Enter</b> (PC) / <b>Done</b> (HP) untuk tambah baris.
  Isi sampling & keranjang untuk otomatis hitung size dan netto.
</div>

<div id="partaiContainer" style="margin-top:14px;"></div>

<script>
  // ========= Helpers =========
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getNumber(val) {
    const n = parseFloat((val || "").toString().trim().replace(",", "."));
    return isNaN(n) ? null : n;
  }

  function getInt(val) {
    const n = parseInt((val || "").toString().trim(), 10);
    return isNaN(n) ? null : n;
  }

  // ========= Load masters =========
  async function loadSuppliers() {
    const res = await fetch("/master/suppliers");
    const rows = await res.json();
    const sel = $("supplier");
    sel.innerHTML = `<option value="">-- Pilih Supplier --</option>` +
      rows.map(r => `<option value="${escapeHtml(r.nama)}">${escapeHtml(r.nama)}</option>`).join("");
  }

  async function loadJenis() {
    const res = await fetch("/master/jenis");
    const rows = await res.json();
    const sel = $("jenis");
    sel.innerHTML = `<option value="">-- Pilih Jenis Udang --</option>` +
      rows.map(r => `<option value="${escapeHtml(r.nama)}">${escapeHtml(r.nama)}</option>`).join("");
  }

  $("btnAddSupplier").addEventListener("click", async () => {
    const nama = ($("supplier_new").value || "").trim();
    if (!nama) return alert("Isi nama supplier dulu");

    const res = await fetch("/master/supplier/add", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ nama })
    });

    const out = await res.json();
    if (!res.ok || !out.ok) return alert(out.msg || "Gagal tambah supplier");

    $("supplier_new").value = "";
    await loadSuppliers();
    alert("Supplier ditambahkan");
  });

  // ========= Partai UI =========
  const partaiContainer = $("partaiContainer");
  const btnSave = $("btnSave");
  let partaiKe = 0;

  function buatPartaiBaru() {
    partaiKe++;

    const partaiDiv = document.createElement("div");
    partaiDiv.className = "partai";
    partaiDiv.dataset.partai = partaiKe;

    partaiDiv.innerHTML = `
      <div class="toprow">
        <div>
          <h3 style="margin:0;">Partai #${partaiKe} <span class="pill">Receiving</span></h3>
          <div class="muted">Isi timbangan di bawah ini</div>
        </div>
      </div>

      <div class="section">
        <div class="muted" style="margin-bottom:8px;"><b>Sampling Partai #${partaiKe}</b> (PCS & Berat Sample kg)</div>
        <div class="grid4">
          <div class="field">
            <label>PCS (ekor)</label>
            <input id="pcs-${partaiKe}" type="number" placeholder="contoh: 234">
          </div>
          <div class="field">
            <label>Berat Sample (kg)</label>
            <input id="kg-${partaiKe}" type="number" step="0.01" placeholder="contoh: 3.5">
          </div>
          <div class="field">
            <label>Size (pcs/kg)</label>
            <input id="size-${partaiKe}" type="text" readonly>
          </div>
          <div class="field">
            <label>Pembulatan (patokan)</label>
            <input id="round-${partaiKe}" type="text" readonly>
          </div>
        </div>
        <div class="muted" style="margin-top:8px;">Rumus: <b>PCS / kg</b> â†’ dibulatkan jadi patokan size & harga.</div>
      </div>

      <div class="section">
        <div class="muted" style="margin-bottom:8px;"><b>Perhitungan Berat</b> (Bruto, Tara, Netto)</div>

        <div class="grid4">
          <div class="field">
            <label>Keranjang (auto)</label>
            <input type="text" id="keranjang-${partaiKe}" readonly>
          </div>

          <div class="field">
            <label>Berat / Keranjang (kg)</label>
            <input type="number" step="0.01" id="tara-${partaiKe}" placeholder="contoh: 2">
          </div>
          <div class="field">
            <label>Total Tara (kg)</label>
            <input type="text" id="total-tara-${partaiKe}" readonly>
          </div>
          <div class="field">
            <label>Total Bruto (kg)</label>
            <input type="text" id="bruto-${partaiKe}" readonly>
          </div>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <div class="field">
            <label>Netto (kg)</label>
            <input type="text" id="netto-${partaiKe}" readonly>
          </div>
          <div class="field">
            <label>Catatan</label>
            <input type="text" id="note-${partaiKe}" placeholder="contoh: kondisi udang baik">
          </div>
          <div class="field"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:80px;">No</th>
            <th>Berat Timbangan</th>
          </tr>
        </thead>
        <tbody id="tbody-${partaiKe}"></tbody>
      </table>

      <div class="row-actions">
        <button class="btn btn-secondary btn-new-partai" type="button">+ Partai Baru</button>
        <button class="btn btn-primary btn-add-row" type="button">+ Baris</button>
      </div>
    `;

    partaiContainer.appendChild(partaiDiv);

    // bind tombol
    partaiDiv.querySelector(".btn-new-partai").addEventListener("click", buatPartaiBaru);
    partaiDiv.querySelector(".btn-add-row").addEventListener("click", () => tambahBaris(partaiKe, true));

    // bind input sampling & tara
    $(`pcs-${partaiKe}`).addEventListener("input", () => hitungSize(partaiKe));
    $(`kg-${partaiKe}`).addEventListener("input", () => hitungSize(partaiKe));
    $(`tara-${partaiKe}`).addEventListener("input", () => hitungBerat(partaiKe));

    // baris timbangan pertama
    tambahBaris(partaiKe, true);
    hitungBerat(partaiKe);
  }

  function tambahBaris(partai, focus=false) {
    const tbody = $(`tbody-${partai}`);
    const rowCount = tbody.children.length + 1;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${rowCount}</td>
      <td>
        <input type="number" step="0.01" inputmode="decimal" class="inp-berat" placeholder="contoh: 34.6">
      </td>
    `;
    tbody.appendChild(tr);

    const input = tr.querySelector("input");

    input.addEventListener("input", () => hitungBerat(partai));

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (!(input.value || "").trim()) return;
        tambahBaris(partai, true);
      }
    });

    input.addEventListener("blur", () => {
      if (!(input.value || "").trim()) return;
      const inputs = tbody.querySelectorAll("input");
      if (inputs[inputs.length - 1] === input) tambahBaris(partai, false);
    });

    if (focus) input.focus();
  }

  function hitungSize(partai) {
    const pcs = getNumber($(`pcs-${partai}`).value) || 0;
    const kg  = getNumber($(`kg-${partai}`).value) || 0;

    const sizeEl  = $(`size-${partai}`);
    const roundEl = $(`round-${partai}`);

    if (pcs > 0 && kg > 0) {
      const size = pcs / kg;
      sizeEl.value = size.toFixed(1);
      roundEl.value = Math.round(size);
    } else {
      sizeEl.value = "";
      roundEl.value = "";
    }
  }

  function hitungBerat(partai) {
    const tbody = $(`tbody-${partai}`);
    let bruto = 0;
    let keranjang = 0;

    tbody.querySelectorAll("input").forEach(inp => {
      const val = getNumber(inp.value);
      if (val !== null) {
        bruto += val;
        keranjang += 1;
      }
    });

    const taraEl = $(`tara-${partai}`);
    const taraRaw = (taraEl.value || "").trim();
    const beratKeranjang = getNumber(taraRaw);

    $(`keranjang-${partai}`).value = keranjang > 0 ? keranjang : "";
    $(`bruto-${partai}`).value = bruto > 0 ? bruto.toFixed(2) : "";

    // RULE: kalau ada timbangan maka tara wajib > 0
    if (keranjang > 0 && (taraRaw === "" || beratKeranjang === null || beratKeranjang <= 0)) {
      $(`total-tara-${partai}`).value = "";
      $(`netto-${partai}`).value = "";
      taraEl.style.borderColor = "#dc2626";
      taraEl.title = "Berat / Keranjang wajib diisi";
      return;
    } else {
      taraEl.style.borderColor = "";
      taraEl.title = "";
    }

    const totalTara = keranjang * beratKeranjang;
    const netto = bruto - totalTara;

    $(`total-tara-${partai}`).value = totalTara > 0 ? totalTara.toFixed(2) : "";
    $(`netto-${partai}`).value = netto > 0 ? netto.toFixed(2) : "";
  }

  function kumpulPayload() {
    const tanggal = $("tanggal").value;
    const supplier = $("supplier").value;
    const jenis = $("jenis").value;
    const fiber = getNumber($("fiber").value);

    const partai = [];

    document.querySelectorAll(".partai").forEach((pEl) => {
      const partaiNo = getInt(pEl.dataset.partai);

      const pcs = getInt($(`pcs-${partaiNo}`).value);
      const kgSample = getNumber($(`kg-${partaiNo}`).value);
      const size = getNumber($(`size-${partaiNo}`).value);
      const roundSize = getInt($(`round-${partaiNo}`).value);

      const keranjang = getInt($(`keranjang-${partaiNo}`).value);
      const taraPerKeranjang = getNumber($(`tara-${partaiNo}`).value);
      const bruto = getNumber($(`bruto-${partaiNo}`).value);
      const totalTara = getNumber($(`total-tara-${partaiNo}`).value);
      const netto = getNumber($(`netto-${partaiNo}`).value);
      const note = ($(`note-${partaiNo}`).value || "").trim();

      const timbangan = [];
      pEl.querySelectorAll(".inp-berat").forEach(inp => {
        const v = getNumber(inp.value);
        if (v !== null) timbangan.push(v);
      });

      // skip partai kosong
      const kosong =
        timbangan.length === 0 &&
        pcs === null &&
        kgSample === null &&
        taraPerKeranjang === null &&
        note === "";

      if (kosong) return;

      partai.push({
        partai_no: partaiNo,
        pcs: pcs,
        kg_sample: kgSample,
        size: size,
        round_size: roundSize,
        keranjang: keranjang,
        tara_per_keranjang: taraPerKeranjang,
        bruto: bruto,
        total_tara: totalTara,
        netto: netto,
        note: note,
        timbangan: timbangan
      });
    });

    return { tanggal, supplier, jenis, fiber, partai };
  }

  btnSave.addEventListener("click", async () => {
  const payload = kumpulPayload();

  if (!payload.tanggal) return alert("Tanggal wajib diisi");
  if (!payload.supplier) return alert("Supplier wajib dipilih");
  if (!payload.jenis) return alert("Jenis udang wajib dipilih");
  if (!payload.partai.length) return alert("Minimal 1 partai");

  try {
    const isTest = document.getElementById("is_test")?.checked;
    const url = isTest ? "/receiving/save?test=1" : "/receiving/save";

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const out = await res.json();
    if (!res.ok || !out.ok) return alert(out.msg || "Gagal simpan");

    alert(`Berhasil disimpan! ID: ${out.header_id}${out.is_test ? " (TEST)" : ""}`);

    // reset header (TAPI jangan reset tanggal, biar enak input berurutan)
    $("supplier").value = "";
    $("jenis").value = "";
    $("fiber").value = "";

    // reset partai
    partaiContainer.innerHTML = "";
    partaiKe = 0;
    buatPartaiBaru();

  } catch (e) {
    alert("Error koneksi: " + e);
  }
});


  // ========= init =========
  (async function init() {
    await Promise.all([loadSuppliers(), loadJenis()]);
    buatPartaiBaru();
  })();
</script>

</body>
</html>
